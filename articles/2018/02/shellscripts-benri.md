---
slug: shellscripts-benri
title: ãŸã¾ã«ä½¿ã†ã‚·ã‚§ãƒ«ã‚³ãƒžãƒ³ãƒ‰ç½®ãå ´
category: programming
date: 2019-02-14 05:00:00
tags: []
pinned: false
---

- ã‚³ãƒžãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã„ã¡ã„ã¡è¦šãˆã¦ãªã„ã®ã§ãƒ¡ãƒ¢ã£ã¨ãç”¨ãƒšãƒ¼ã‚¸
- ã“ã®ãƒšãƒ¼ã‚¸ã®å†…å®¹ã‚’ä¿¡ç”¨ã—ã¦èµ·ããŸäº‹æ•…ãªã©ä¸€åˆ‡æ„ŸçŸ¥ã—ãªã„ã®ã§ã€è‡ªå·±è²¬ä»»ã§è¦‹ã¦ãã ã•ã„

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å­˜åœ¨ç¢ºèª

### è¤‡æ•°ã®ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹

å®Ÿè¡Œçµæžœ

```sh
$ for i in `awk /gomi-/'{print $2}' /etc/hosts`; do echo "$i:"; ssh $i '[ -d /etc/elasticsearch ]; echo $?'; done;
gomi-web01
1
gomi-back01
0
```

- `-w`: writable
- `-x`: executable
- `-e`: path
- `-d`: directory
- `-f`: file
- `-s`: empty file

## ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ã‚µã‚¤ã‚ºç¢ºèª

æ¨©é™å‘¨ã‚Šã§ã†ã¾ãé›†è¨ˆã§ããªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã®ã§ sudo ã‚’ã¤ã‘ãŸã‚Šã€é©åˆ‡ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãªã£ã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ã¨ã‚ˆã„

```sh
$ sudo du -sh /home/common/*
4.0K	/home/common/app
112K	/home/common/logs
```

- `-s`: --summarize
- `-h`: --human-readable

## ç§˜å¯†éµé–¢é€£

### ç”Ÿæˆ

```sh
$ ssh-keygen -t rsa -b 4096
```

### å…¬é–‹éµã®ç¢ºèª

```
$ ssh-keygen -y -f ~/.ssh/id_rsa
```

## mkdir && cd

```
tmp $ mkdir hoge
tmp $ cd $_
hoge $
```

## Git

### å·®åˆ†ãŒã§ãŸãƒ•ã‚¡ã‚¤ãƒ«åã ã‘ã‚’å–å¾—ã™ã‚‹

```
$ git diff --name-only HEAD HEAD~1
group_vars/web/php_vars.yml
roles/nginx/tasks/main.yml
```

### ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã®å–å¾—

```
$ git rev-parse HEAD
efdcc7fdcfbdc53149c92e666f0190bfc530562f
```

## ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã¾ã‚ã‚Š

### ã¨ã‚Šã‚ãˆãšæ‰“ã£ã¨ã

root ã«ãªã‚‰ãªã„ã¨ä¸€éƒ¨ã®æƒ…å ±ãŒè¦‹ãˆãªã„ã®ã§ã€æ°—ã‚’ã¤ã‘ã‚‹

```
$ sudo netstat -antp
```

- `-a`: With the default display, show the state of all sockets; normally sockets used by server processes are not shown. With the routing table display (option -r, as described below), show protocol-cloned routes (routes generated by a RTF_PRCLONING parent route); normally these routes are not shown.
- `-n`: Show network addresses as numbers (normally netstat interprets addresses and attempts to display them symbolically). This option may be used with any of the display formats.
- `-t`: tcp (`--tcp`) ã«çµžã‚‹
- `-p`: Show the PID and name of the program to which each socket belongs.

## bash

- `Ctrl` + `u`: ãƒ©ã‚¤ãƒ³ã‚¯ãƒªã‚¢
- `Ctrl` + `y`: ã‚¯ãƒªã‚¢ã—ãŸæ–‡å­—åˆ—ã‚’å¾©æ´»ã•ã›ã‚‹

### ä¸¦åˆ—ã«ãƒªãƒ¢ãƒ¼ãƒˆã‚³ãƒžãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹

- ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚Œã°ã€ä¸¦åˆ—ã«å®Ÿè¡Œã—ã€ã™ã¹ã¦ã®çµ‚äº†ã‚’å¾…ã¡åˆã‚ã›ã¦å‡¦ç†ã®å®Ÿè¡Œã‚’å®Œäº†ã•ã›ã¦ãã‚Œã‚‹

```sh
for host in `grep web /etc/hosts | awk '{print $2}'`;
do
  ssh $host ...é‡ã„å‡¦ç†... &;
  wait;
done;
```

### ã‚¸ãƒ§ãƒ–åˆ¶å¾¡

```
$ # é‡ã„ã‚¿ã‚¹ã‚¯
$ sleep 100000000


^Z #=> ã‚¿ã‚¹ã‚¯ã®ã‚µã‚¹ãƒšãƒ³ãƒ‰
[1]+  Stopped                 sleep 100000000
$
$ # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å†é–‹
$ bg 1
[1]+ sleep 100000000 &
$
$ # ã‚¸ãƒ§ãƒ–ä¸€è¦§ç¢ºèª
$ jobs
[1]+  Running                 sleep 100000000 &
$
$ # ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã¸
$ fg 1
sleep 100000000
```

## grep

### ps grep æ™‚ã« grep ãƒ—ãƒ­ã‚»ã‚¹ã‚’å¼•ã£æŽ›ã‘ãªã„

- grep ã®æœ«å°¾ã‚’ `[]` ã«çªã£è¾¼ã‚“ã§ãŠãå¤æ¥ã‚ˆã‚Šä¼ã‚ã‚‹æ–¹æ³•ï¼ˆï¼Ÿï¼‰ãŒã‚ã‚‹

```
$ ps -ef | grep ngin[x]
nginx      317 26695  1 22:31 ?        00:00:16 php-fpm: pool www
nginx      825 26695  1 22:35 ?        00:00:15 php-fpm: pool www
nginx    14515 32243  0 15:00 ?        00:00:59 nginx: worker process
nginx    14516 32243  0 15:00 ?        00:00:36 nginx: worker process
nginx    18690 26695  0 20:25 ?        00:01:30 php-fpm: pool www
root     32243     1  0 Feb03 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf
```

## AWS CLI

### ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒªã‚¹ãƒˆã®å–å¾—

```
$ aws ec2 describe-instances | jq '.Reservations[].Instances[] | { Name: (.Tags[]? | select(.Key == "Name")).Value, State: .State.Name, InstanceId, PublicIpAddress }'
{
  "Name": "web01",
  "State": "stopped",
  "InstanceId": "i-............",
  "PublicIpAddress": null
}
{
  "Name": "bastion01",
  "State": "stopped",
  "InstanceId": "i-............",
  "PublicIpAddress": "xx.xx.xx.xx"
}
```

### SNS ãƒˆãƒ”ãƒƒã‚¯ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ ARN ã®æŠ½å‡º

```
$ aws sns list-subscriptions | jq -r '.Subscriptions[] | select(.TopicArn | test("HogeFuga")) | .SubscriptionArn'
arn:aws:sns:ap-northeast-1:ðŸ˜‡:HogeFuga:ðŸ˜‡
arn:aws:sns:ap-northeast-1:ðŸ˜‡:HogeFuga:ðŸ˜‡
...
```

## MongoDB ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆ

### Docker ã‚¤ãƒ¡ãƒ¼ã‚¸

[mongo - Docker Hub](https://hub.docker.com/_/mongo/)

```
$ brew tap mongodb/brew
$ brew install mongodb-community@4.0
$ docker run --name test-mongo -d mongo:latest
$ docker exec -it test-mongo bash
```

### åŸºæœ¬æ“ä½œ

```
# ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆ
> db.createCollection('test')
{ "ok" : 1 }

# ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä¸€è¦§
> show dbs
admin   0.000GB
config  0.000GB
local   0.000GB
test    0.000GB

# ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å‰Šé™¤
> db.test.drop()
true

# ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 
> db.test.insert({'id':1, 'name':'hage'})
WriteResult({ "nInserted" : 1 })

# ãƒ‡ãƒ¼ã‚¿ã®æ¤œç´¢
db.test.find()
{ "_id" : ObjectId("5ce823f39130afabdf41a5fd"), "id" : 1, "name" : "hage" }
{ "_id" : ObjectId("5ce823fb9130afabdf41a5fe"), "id" : 2, "name" : "fuga" }
{ "_id" : ObjectId("5ce824029130afabdf41a5ff"), "id" : 3, "name" : "piyo" }

> db.test.find({'name':'fuga'})
{ "_id" : ObjectId("5ce823fb9130afabdf41a5fe"), "id" : 2, "name" : "fuga" }

# ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
> res = db.test.find()[0]
{ "_id" : ObjectId("5ce822d59130afabdf41a5fc"), "id" : 1, "name" : "hage" }
> db.test.remove(res)
WriteResult({ "nRemoved" : 1 })
```

# é›†è¨ˆ

```
> db.order.find()
{ "_id" : ObjectId("5ce825729130afabdf41a604"), "order_id" : 1, "user_id" : 2, "amount" : 12 }
{ "_id" : ObjectId("5ce8257a9130afabdf41a605"), "order_id" : 2, "user_id" : 1, "amount" : 41 }
{ "_id" : ObjectId("5ce825809130afabdf41a606"), "order_id" : 1, "user_id" : 1, "amount" : 13 }
> db.order.aggregate([
     { $match: { 'user_id':1} },
     { $group: { _id : "$user_id", sum: { $sum: "$amount" }} }
])
{ "_id" : 1, "sum" : 54 }
```

## openssl ã‚³ãƒžãƒ³ãƒ‰

[OpenSSL Essentials: Working with SSL Certificates, Private Keys and CSRs | DigitalOcean](https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs)

### CSR ã¨ã¯ä½•ã‹

SSL è¨¼æ˜Žæ›¸ã‚’èªè¨¼å±€(CA: Certificate Authority)ã‹ã‚‰å¾—ã‚‹ãŸã‚ã«ç½²åãƒªã‚¯ã‚¨ã‚¹ãƒˆ(CSR: Certificate Signing Request)ãŒå¿…è¦ã¨ãªã‚Šã¾ã™ã€‚

CSR ã‚’ç™ºè¡Œã™ã‚‹ã¨ãã«ã¯ DN(Distinguished Name) ã¨ã‚ˆã°ã‚Œã‚‹æƒ…å ±ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚SSL è¨¼æ˜Žæ›¸ã®ç™ºè¡Œã«éš›ã—ã¦ã¯ç‰¹ã« Common Name ã™ãªã‚ã¡ FQDN ãŒé‡è¦ãªé …ç›®ã¨ãªã£ã¦ãã¾ã™ã€‚ãã®ã»ã‹çµ„ç¹”åãªã©ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚

#### CSR ã®ç”Ÿæˆ

openssl ã‚³ãƒžãƒ³ãƒ‰ã‚’åˆ©ç”¨ã—ã¦ç°¡å˜ã« CSR ã‚’ç”Ÿæˆå¯èƒ½ã§ã™

```
$ openssl req \
>        -newkey rsa:2048 \
>        -nodes -keyout domain.key \
>        -out domain.csr
Generating a 2048 bit RSA private key
..........+++
............................+++
writing new private key to 'domain.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:JP
State or Province Name (full name) [Some-State]:Tokyo
Locality Name (eg, city) []:Tokyo
Organization Name (eg, company) [Internet Widgits Pty Ltd]:53ningen
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:53ningen.com
Email Address []:

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
```

### è‡ªå·±ç½²åè¨¼æ˜Žæ›¸ã®ç”Ÿæˆ

```
$ openssl req \
>        -newkey rsa:2048 -nodes -keyout domain.key \
>        -x509 -days 365 -out domain.crt
Generating a 2048 bit RSA private key
........................................+++
.......................................................+++
writing new private key to 'domain.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:JP
State or Province Name (full name) [Some-State]:Tokyo
Locality Name (eg, city) []:Tokyo
Organization Name (eg, company) [Internet Widgits Pty Ltd]:example
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:53ningen.com
Email Address []:
```
