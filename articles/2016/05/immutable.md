---
title: Immutable パターン
category: programming
date: 2016-05-16 22:12:03
tags: [Java, デザインパターン]
pinned: false
---

<p>結城先生のデザパタ本マルチスレッド編　第2章のまとめ</p>

<h2>問題</h2>

<p>複数のスレッドがインスタンスを共有しているが、インスタンスの状態は変化しない。
このときに、何も考えず <code>Single Threaded Execution</code> パターンを使うとスループットが落ちてしまいます。</p>

<h2>解決方法</h2>

<p>インスタンスが状態変化しないのであれば <code>Single Threaded Execution</code> パターンを使う必要はありません。
その場合は意図しない状態変化を防ぐためにフィールドが変化しないようにする <code>Immutable</code> パターンを用います。
不変性を保つのは大変なので、気をつけて実装する必要があります。またドキュメントにクラスが不変であることを明示する方が良いでしょう。</p>

<h2>関連するパターン</h2>

<ul>
<li>状態を変更するスレッドが参照するスレッドの数よりも少ないときは、<code>Read-Write Lock</code> パターンが使えます</li>
</ul>

<p>コード例はあまりにもつまらないので割愛</p>

<h2>適用可能性</h2>

<ul>
<li>インスタンスの生成後、状態が変化しない時</li>
<li>インスタンスが共有され、頻繁にアクセスされるとき</li>
</ul>

<h2>余談</h2>

<h3>mutable なクラスと immutable なクラス</h3>

<p>Java 標準ライブラリには mutable なクラスと immutable なクラスが対になっているものがある。</p>

<ul>
<li>java.lang.String</li>
<li>java.lang.StringBuffer</li>
</ul>

<h3>不変性を守るために</h3>

<ul>
<li>フィールドの保持している mutable なインスタンスをそのまま返すようなことをすると不変性が破られる可能性がある</li>
<li>コンストラクタに引数として渡したインスタンスをそのままフィールドに代入した場合、不変性が破られる可能性がある</li>
</ul>
